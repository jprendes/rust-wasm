# Running Rust in the browser with `wasm-bindgen`

This guide will show you how to run Rust in de browser using `wasm-bindgen`.

## Writing the module

Let's create our own `demo` component, we need a crate for it
```bash
cargo init --lib --name demo
```

We need to specify the crate type by adding to `./Cargo.toml`
```toml
[lib]
crate-type = ["cdylib"]
```

We also need to add `wasm-bindgen` as a dependency
```bash
cargo add wasm-bindgen
```

Lets now edit `src/lib.rs` to add function that count the number of `x` characters in a string
```rust
#[wasm_bindgen]
pub struct Stats {
    pub total: u32,
    pub count: u32,
}

#[wasm_bindgen]
pub fn count_x(s: &str) -> Stats {
    let total = s.len() as _;
    let count = s.as_bytes().iter().filter(|x| **x == b'x').count() as _;
    Stats { total, count }
}
```

## Compiling it

Building the WebAssembly module invovles 2 steps:
1. Compiling
```bash
cargo build --release --target=wasm32-unknown-unknown
```

2. Generating the JS bindings
```bash
wasm-bindgen target/wasm32-unknown-unknown/release/demo.wasm --out-dir wasm --target web
```

## Running it

To run our code we create a `main.js` file and import the generated JavaScript bindings

```js
import init, { count_x } from "./wasm/demo.js"
```

Not that there's an `init` function. This is an async function that we need to call and await before using the `count_x` function.
```js
await init({});
```

Now we can call the `count_x` function
```js
const msg = "hello xoxoxo";
const stats = count_x(msg);
console.log(`"${msg}" has ${stats.count} letters "x" out of ${stats.total} in total`);
```

The generated bindings will take care of handling the input string, as well as the returned stats struct.

We can run this with Deno
```bash
deno -A main.js
```

which prints
```
"hello xoxoxo" has 3 letters "x" out of 12 in total
```

## Interacting with the host

To interact with the host we need to import functionalities from the host

```rust
#[wasm_bindgen(module="../host.js")]
extern {
    fn print(s: &str);
}
```

The bindings generated by `wasm-bindgen` will import `../host.js` which must export a `print` function

```js
export function print(str) {
    console.log(str)
}
```

Lets now add a `greet` function
```rust
#[wasm_bindgen]
pub fn greet(name: &str) {
    let s = format!("hello {name}, from Rust!");
    print(&s);
}
```

Now in `main.js` We can now import `greet`
```js
import init, { count_x, greet } from "./wasm/demo.js"
```

and call it
```js
greet("Jorge");
```

which when run with Deno prints
```
hello Jorge, from Rust!
```

## Running in the browser

To run the script in the browser we need an `index.html` file
```html
<!doctype html>
<script type="module" src="./main.js"></script>
```

and now we can run `serve` and direct our browser to http://localhost:8000.

## Further reading

`wasm-bindgen` provides a plethora of features, check them out [here](https://rustwasm.github.io/wasm-bindgen/).
